<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - School Accounting System</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #6f42c1 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #dc3545;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        h2 {
            color: #444;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 3px solid #ddd;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
            margin-bottom: 0;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #e9ecef;
            border: none;
            margin-right: 2px;
            font-weight: 600;
            color: #555;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tab:hover {
            background: #dee2e6;
            color: #333;
            transform: translateY(-2px);
        }

        .tab.active {
            background: #dc3545;
            color: white;
            border-bottom: 3px solid #a71e2a;
        }

        .tab-content {
            display: none !important;
            padding: 30px !important;
            background: white !important;
            border-radius: 0 0 8px 8px !important;
            min-height: 400px !important;
        }

        .tab-content.active {
            display: block !important;
        }

        /* Forms */
        form {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220,53,69,0.1);
        }

        /* Buttons */
        button {
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #a71e2a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Messages */
        .error {
            color: #dc3545;
            font-weight: 600;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            font-weight: 600;
            margin-top: 10px;
        }

        .warning {
            color: #ffc107;
            font-weight: 600;
            margin-top: 10px;
        }

        .info {
            color: #17a2b8;
            font-weight: 600;
            margin-top: 10px;
        }

        /* Admin Info */
        .admin-info {
            background: linear-gradient(135deg, #ffeaea 0%, #ffe6e6 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 5px solid #dc3545;
            font-weight: 500;
        }

        /* Super Admin Badge */
        .super-admin-badge {
            background: #dc3545;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Security Warning */
        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-right: 0;
                margin-bottom: 2px;
                text-align: center;
                border-radius: 6px;
            }

            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>

<!-- LOGIN SECTION -->
<div class="container" id="auth-section">
    <h1>ğŸ” Super Admin Portal</h1>
    
    <div class="security-warning">
        <h4>âš ï¸ Restricted Access</h4>
        <p><strong>This is a Super Administrator portal.</strong> Only authorized Super Admins should access this interface. All actions are logged and monitored.</p>
    </div>
    
    <form id="login-form">
        <div class="form-group">
            <label>Super Admin Email</label>
            <input type="email" id="login-email" required placeholder="Enter your super admin email">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-password" required placeholder="Enter your password">
        </div>
        <button type="submit">ğŸ” Super Admin Login</button>
        <button type="button" id="create-super-admin-btn" style="background: #28a745; margin-top: 10px;">â• Create Super Admin Account</button>
        <div id="login-message"></div>
    </form>
    
    <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
        <h4>ğŸ”— Regular Admin Access</h4>
        <p>For regular admin functions (Finance Admin, Registrar, Accountant), please use the <a href="index-working.html" style="color: #007bff; text-decoration: none;">main admin portal</a>.</p>
    </div>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <h4>ğŸ” Super Admin Credentials</h4>
        <p><strong>Default Super Admin:</strong> admin@school.com / admin123</p>
        <p><strong>Alternative:</strong> superadmin@school.com / superadmin123</p>
        <p><em>Note: You can also use any super admin account created through the system.</em></p>
    </div>
</div>

<!-- MAIN SUPER ADMIN APP -->
<div class="container" id="app-section" style="display:none;">
    <div class="admin-info">
        <strong>Super Admin:</strong> <span id="admin-email">admin@school.com</span> | 
        <span class="super-admin-badge">Super Admin</span> | 
        <strong>Session:</strong> <span id="session-time">12:00:00</span>
    </div>
    
    <h1>ğŸ” Super Admin Control Panel</h1>
    
    <div class="security-warning">
        <h4>ğŸ›¡ï¸ Super Admin Privileges Active</h4>
        <p>You have full system access. Use these powers responsibly. All actions are logged.</p>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="system-overview">System Overview</button>
        <button class="tab" data-tab="admin-management">Admin Management</button>
        <button class="tab" data-tab="term-management">Term Management</button>
        <button class="tab" data-tab="fee-management">Fee Management</button>
        <button class="tab" data-tab="system-settings">System Settings</button>
        <button class="tab" data-tab="audit-logs">Audit Logs</button>
        <button class="tab" data-tab="backup-restore">Backup & Restore</button>
        <button class="tab" id="logout-btn" style="margin-left:auto; background:#6c757d;">Logout</button>
    </div>

    <!-- SYSTEM OVERVIEW -->
    <div id="system-overview" class="tab-content active">
        <h2>ğŸ“Š System Overview</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                <h4 style="margin: 0 0 10px 0; color: #28a745;">ğŸ‘¥ Total Students</h4>
                <div style="font-size: 2em; font-weight: bold; color: #28a745;" id="total-students">Loading...</div>
            </div>
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ‘¨â€ğŸ’¼ Total Admins</h4>
                <div style="font-size: 2em; font-weight: bold; color: #856404;" id="total-admins">Loading...</div>
            </div>
            <div style="background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                <h4 style="margin: 0 0 10px 0; color: #17a2b8;">ğŸ“… Active Terms</h4>
                <div style="font-size: 2em; font-weight: bold; color: #17a2b8;" id="active-terms">Loading...</div>
            </div>
            <div style="background: #ffeaea; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                <h4 style="margin: 0 0 10px 0; color: #dc3545;">ğŸ’° Total Revenue</h4>
                <div style="font-size: 2em; font-weight: bold; color: #dc3545;" id="total-revenue">Loading...</div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; border-left: 4px solid #6f42c1;">
                <h4 style="margin: 0 0 10px 0; color: #6f42c1;">ğŸ“ˆ Monthly Revenue</h4>
                <div style="font-size: 1.5em; font-weight: bold; color: #6f42c1;" id="monthly-revenue">Loading...</div>
            </div>
            <div style="background: #ffe6e6; padding: 20px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                <h4 style="margin: 0 0 10px 0; color: #e74c3c;">âš ï¸ Outstanding Payments</h4>
                <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;" id="outstanding-count">Loading...</div>
            </div>
            <div style="background: #e8f8f5; padding: 20px; border-radius: 8px; border-left: 4px solid #00d4aa;">
                <h4 style="margin: 0 0 10px 0; color: #00d4aa;">ğŸ“Š Data Status</h4>
                <div style="font-size: 1em; color: #00d4aa;" id="data-status">
                    <div>Last Updated: <span id="last-updated">Loading...</span></div>
                    <div style="margin-top: 5px;">Backend: <span id="backend-status-text">Connected</span></div>
                </div>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h4>ğŸ”„ Quick Actions</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="refreshSystemStats()" style="background: #17a2b8;">ğŸ”„ Refresh Stats</button>
                <button onclick="testBackendConnection()" style="background: #6c757d;">ğŸ”§ Test Backend</button>
                <button onclick="loadFallbackStats()" style="background: #fd7e14;">ğŸ§ª Load Test Data</button>
                <button onclick="exportSystemData()" style="background: #28a745;">ğŸ“¥ Export Data</button>
                <button onclick="viewSystemLogs()" style="background: #6f42c1;">ğŸ“‹ View Logs</button>
                <button onclick="openRegularAdmin()" style="background: #fd7e14;">ğŸ¢ Open Regular Admin</button>
                <button onclick="viewDetailedStats()" style="background: #20c997;">ğŸ“ˆ Detailed Stats</button>
            </div>
        </div>
        
        <div id="detailed-stats" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4>ğŸ“Š Detailed Statistics</h4>
            <div id="class-breakdown" style="margin-top: 15px;">
                <h5>Students by Class:</h5>
                <div id="class-stats">Loading class breakdown...</div>
            </div>
        </div>
    </div>

    <!-- ADMIN MANAGEMENT -->
    <div id="admin-management" class="tab-content">
        <h2>ğŸ‘¨â€ğŸ’¼ Administrator Management</h2>
        
        <div style="background: #ffeaea; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
            <strong>âš ï¸ Super Admin Only:</strong> Only Super Administrators can create, modify, or delete admin accounts.
        </div>
        
        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
            <h4>Role Permissions Hierarchy</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;">
                <div>
                    <strong style="color: #dc3545;">ğŸ” Super Admin</strong>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li>All system features</li>
                        <li>Manage administrators</li>
                        <li>Manage academic terms</li>
                        <li>System settings & backup</li>
                    </ul>
                </div>
                <div>
                    <strong style="color: #fd7e14;">ğŸ’° Finance Admin</strong>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li>Student registration</li>
                        <li>Fee structure management</li>
                        <li>Payment recording</li>
                        <li>Financial reports</li>
                    </ul>
                </div>
                <div>
                    <strong style="color: #6f42c1;">ğŸ“ Registrar</strong>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li>Student registration</li>
                        <li>Student search</li>
                        <li>Generate reports</li>
                        <li>Fee receipts</li>
                    </ul>
                </div>
                <div>
                    <strong style="color: #20c997;">ğŸ’³ Accountant</strong>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                        <li>Payment recording</li>
                        <li>Student search</li>
                        <li>Generate reports</li>
                        <li>Fee receipts</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <form id="admin-form">
            <div class="form-group">
                <label>Admin Email</label>
                <input type="email" id="admin-email-input" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="admin-password-input" required placeholder="Enter password for new admin">
                <small style="color: #6c757d; font-size: 12px;">Password must be at least 6 characters long</small>
            </div>
            <div class="form-group">
                <label>Admin Role</label>
                <select id="admin-role-input" required>
                    <option value="">-- Select Role --</option>
                    <option value="super_admin">ğŸ” Super Admin</option>
                    <option value="finance_admin">ğŸ’° Finance Admin</option>
                    <option value="registrar">ğŸ“ Registrar</option>
                    <option value="accountant">ğŸ’³ Accountant</option>
                </select>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="admin-fullname" required>
            </div>
            <button type="submit">â• Add Administrator</button>
            <div id="admin-form-message"></div>
        </form>
        
        <div style="overflow-x: auto; margin-top: 25px;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Email</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Full Name</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Role</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Password</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Status</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Actions</th>
                    </tr>
                </thead>
                <tbody id="admins-table-body">
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">Loading administrators...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- TERM MANAGEMENT -->
    <div id="term-management" class="tab-content">
        <h2>ğŸ“… Academic Term Management</h2>
        
        <form id="term-form">
            <div class="form-group">
                <label>Term Name</label>
                <input type="text" id="term-name" placeholder="e.g., First Term 2024" required>
            </div>
            <div class="form-group">
                <label>Academic Year</label>
                <input type="text" id="academic-year" placeholder="e.g., 2024/2025" required>
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="term-start-date" required>
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="term-end-date" required>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="term-status" required>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <button type="submit">â• Add Term</button>
            <div id="term-message"></div>
        </form>
        
        <div style="overflow-x: auto; margin-top: 25px;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Term Name</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Academic Year</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Start Date</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">End Date</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Status</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Actions</th>
                    </tr>
                </thead>
                <tbody id="terms-table-body">
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">Loading terms...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- FEE MANAGEMENT -->
    <div id="fee-management" class="tab-content">
        <h2>ğŸ’° Fee Management</h2>
        
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <strong>â„¹ï¸ Info:</strong> Manage school fees by term and class. Super Admins and Finance Admins can add, edit, and delete fee structures.
        </div>
        
        <form id="fee-form">
            <div class="form-group">
                <label>Fee Name</label>
                <input type="text" id="fee-name" placeholder="e.g., Tuition Fee, Library Fee" required>
            </div>
            <div class="form-group">
                <label>Fee Amount (â‚¦)</label>
                <input type="number" id="fee-amount" placeholder="e.g., 50000" min="0" step="100" required>
            </div>
            <div class="form-group">
                <label>Term</label>
                <select id="fee-term" required>
                    <option value="">-- Select Term --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Class</label>
                <select id="fee-class" required>
                    <option value="">-- Select Class --</option>
                    <option value="JSS 1">JSS 1</option>
                    <option value="JSS 2">JSS 2</option>
                    <option value="JSS 3">JSS 3</option>
                    <option value="SS 1">SS 1</option>
                    <option value="SS 2">SS 2</option>
                    <option value="SS 3">SS 3</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fee Category</label>
                <select id="fee-category" required>
                    <option value="">-- Select Category --</option>
                    <option value="tuition">Tuition</option>
                    <option value="development">Development</option>
                    <option value="library">Library</option>
                    <option value="sports">Sports</option>
                    <option value="laboratory">Laboratory</option>
                    <option value="examination">Examination</option>
                    <option value="miscellaneous">Miscellaneous</option>
                </select>
            </div>
            <button type="submit">â• Add Fee</button>
            <div id="fee-form-message"></div>
        </form>
        
        <div style="margin: 20px 0;">
            <button onclick="loadFeesList()" style="background: #17a2b8;">ğŸ”„ Refresh Fees</button>
            <button onclick="exportFeesData()" style="background: #28a745;">ğŸ“¥ Export Fees</button>
        </div>
        
        <div style="overflow-x: auto; margin-top: 25px;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Fee Name</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Amount (â‚¦)</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Term</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Class</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Category</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Status</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Actions</th>
                    </tr>
                </thead>
                <tbody id="fees-table-body">
                    <tr>
                        <td colspan="7" style="padding: 20px; text-align: center; color: #6c757d;">Loading fees...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- SYSTEM SETTINGS -->
    <div id="system-settings" class="tab-content">
        <h2>âš™ï¸ System Settings</h2>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong>âš ï¸ Warning:</strong> Changes to system settings affect all users. Proceed with caution.
        </div>
        
        <form id="settings-form">
            <h3>ğŸ« School Information</h3>
            <div class="form-group">
                <label>School Name</label>
                <input type="text" id="school-name" value="Victory Model College School" required>
            </div>
            <div class="form-group">
                <label>School Address</label>
                <textarea id="school-address" rows="3">Enter school address here</textarea>
            </div>
            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" id="school-email" value="info@vmcs.edu">
            </div>
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="tel" id="school-phone" value="+234-XXX-XXX-XXXX">
            </div>
            
            <h3>ğŸ’° Currency Settings</h3>
            <div class="form-group">
                <label>Currency Symbol</label>
                <input type="text" id="currency-symbol" value="â‚¦" maxlength="3">
            </div>
            <div class="form-group">
                <label>Currency Name</label>
                <input type="text" id="currency-name" value="Nigerian Naira">
            </div>
            
            <button type="submit">ğŸ’¾ Save Settings</button>
            <div id="settings-message"></div>
        </form>
    </div>

    <!-- AUDIT LOGS -->
    <div id="audit-logs" class="tab-content">
        <h2>ğŸ“‹ System Audit Logs</h2>
        
        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
            <strong>â„¹ï¸ Info:</strong> All administrative actions are logged for security and compliance purposes.
        </div>
        
        <div style="margin-bottom: 20px;">
            <button onclick="loadAuditLogs()" style="background: #17a2b8;">ğŸ”„ Refresh Logs</button>
            <button onclick="exportAuditLogs()" style="background: #28a745;">ğŸ“¥ Export Logs</button>
            <button onclick="clearOldLogs()" style="background: #ffc107; color: #000;">ğŸ—‘ï¸ Clear Old Logs</button>
        </div>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Timestamp</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">User</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Action</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Details</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">IP Address</th>
                    </tr>
                </thead>
                <tbody id="audit-logs-body">
                    <tr>
                        <td colspan="5" style="padding: 20px; text-align: center; color: #6c757d;">Click "Refresh Logs" to load audit trail</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- BACKUP & RESTORE -->
    <div id="backup-restore" class="tab-content">
        <h2>ğŸ’¾ Backup & Restore</h2>
        
        <div style="background: #ffeaea; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
            <strong>âš ï¸ Critical:</strong> Always create backups before making major system changes.
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div>
                <h3>ğŸ“¥ Create Backup</h3>
                <div class="form-group">
                    <label>Backup Name</label>
                    <input type="text" id="backup-name" placeholder="e.g., Monthly_Backup_Jan_2024">
                </div>
                <div class="form-group">
                    <label>Include Data</label>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="backup-students" checked style="width: auto; margin-right: 8px;">
                            Students Data
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="backup-payments" checked style="width: auto; margin-right: 8px;">
                            Payments Data
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="backup-admins" checked style="width: auto; margin-right: 8px;">
                            Admin Accounts
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="backup-settings" checked style="width: auto; margin-right: 8px;">
                            System Settings
                        </label>
                    </div>
                </div>
                <button onclick="createBackup()" style="background: #28a745;">ğŸ’¾ Create Backup</button>
                <div id="backup-message"></div>
            </div>
            
            <div>
                <h3>ğŸ“¤ Restore from Backup</h3>
                <div class="form-group">
                    <label>Select Backup File</label>
                    <input type="file" id="restore-file" accept=".json,.csv">
                </div>
                <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin: 15px 0;">
                    <strong>âš ï¸ Warning:</strong> Restoring will overwrite current data. This action cannot be undone.
                </div>
                <button onclick="restoreBackup()" style="background: #ffc107; color: #000;">ğŸ“¤ Restore Backup</button>
                <div id="restore-message"></div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>ğŸ“‹ Available Backups</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #dee2e6;">Backup Name</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">Date Created</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">Size</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backups-table-body">
                        <tr>
                            <td colspan="4" style="padding: 20px; text-align: center; color: #6c757d;">No backups available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Super Admin Portal JavaScript
console.log('Super Admin Portal loaded successfully');

// Global variables
var scriptURL = 'https://script.google.com/macros/s/AKfycbxR2e44gYoXELURFHfN98Y8mkD18DFVIZgM0ocGW6vxXW3ta6OW3hwgv2Yo8aA_qX7C/exec';
var currentAdmin = null;

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Super Admin Portal DOM loaded, initializing...');
    
    // Check for saved login
    checkSavedLogin();
    
    // Add login form handler
    var loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
    
    // Add create super admin button handler
    var createSuperAdminBtn = document.getElementById('create-super-admin-btn');
    if (createSuperAdminBtn) {
        createSuperAdminBtn.addEventListener('click', handleCreateSuperAdmin);
    }
    
    // Initialize tab switching if logged in
    if (currentAdmin) {
        initializeTabs();
        updateSessionTime();
        setInterval(updateSessionTime, 60000);
    }
});

// Check for saved login
function checkSavedLogin() {
    var savedAdmin = localStorage.getItem('superAdmin');
    if (savedAdmin) {
        try {
            currentAdmin = JSON.parse(savedAdmin);
            if (currentAdmin.role === 'super_admin') {
                showApp();
            } else {
                localStorage.removeItem('superAdmin');
                showLogin();
            }
        } catch (e) {
            localStorage.removeItem('superAdmin');
            showLogin();
        }
    } else {
        showLogin();
    }
}

// Show login screen
function showLogin() {
    document.getElementById('auth-section').style.display = 'block';
    document.getElementById('app-section').style.display = 'none';
}

// Show main app
function showApp() {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('app-section').style.display = 'block';
    
    // Update admin info display
    if (currentAdmin) {
        document.getElementById('admin-email').textContent = currentAdmin.email;
    }
    
    // Initialize app functionality
    initializeTabs();
    updateSessionTime();
    setInterval(updateSessionTime, 60000);
    
    // Load initial data
    loadSystemStats();
    loadAdminsList();
    loadTermsTable();
    loadTermsForFees();
    loadFeesList();
}

// Handle create super admin account
function handleCreateSuperAdmin() {
    var email = document.getElementById('login-email').value.trim();
    var password = document.getElementById('login-password').value;
    var msg = document.getElementById('login-message');
    
    if (!email || !password) {
        msg.className = 'error';
        msg.textContent = 'Please enter email and password to create super admin account';
        return;
    }
    
    // Validate email format
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        msg.className = 'error';
        msg.textContent = 'Please enter a valid email address';
        return;
    }
    
    // Validate password strength
    if (password.length < 6) {
        msg.className = 'error';
        msg.textContent = 'Password must be at least 6 characters long';
        return;
    }
    
    msg.className = 'info';
    msg.textContent = 'Creating Super Admin account...';
    
    console.log('Creating super admin account for:', email);
    
    makeJsonpRequest({
        action: 'signupAdmin',
        email: email,
        password: password,
        role: 'super_admin',
        fullName: email.split('@')[0] + ' (Super Admin)'
    }, function(res) {
        console.log('Create super admin response:', res);
        
        if (res.success) {
            msg.className = 'success';
            msg.textContent = 'Super Admin account created successfully! You can now login.';
        } else {
            msg.className = 'warning';
            msg.textContent = res.message || 'Super Admin account may already exist. Try logging in.';
        }
    });
}

// Handle login
function handleLogin(e) {
    e.preventDefault();
    console.log('Super Admin login form submitted');
    
    var email = document.getElementById('login-email').value.trim();
    var password = document.getElementById('login-password').value;
    var msg = document.getElementById('login-message');
    
    // Validate inputs
    if (!email || !password) {
        msg.className = 'error';
        msg.textContent = 'Please fill all fields';
        return;
    }
    
    // Show loading message
    msg.className = 'info';
    msg.textContent = 'Authenticating Super Admin...';
    
    console.log('Attempting super admin login for:', email);
    
    // First try backend authentication for super admin role
    makeJsonpRequest({
        action: 'loginAdmin',
        email: email,
        password: password,
        role: 'super_admin'
    }, function(res) {
        console.log('Backend super admin login response:', res);
        
        if (res.success && res.role === 'super_admin') {
            // Successful backend authentication as super admin
            console.log('Backend authentication successful for super admin');
            currentAdmin = {
                email: email,
                role: 'super_admin',
                fullName: res.fullName || email
            };
            
            localStorage.setItem('superAdmin', JSON.stringify(currentAdmin));
            msg.className = 'success';
            msg.textContent = 'Super Admin authentication successful! (Backend)';
            
            setTimeout(function() {
                showApp();
            }, 1000);
            return;
        }
        
        // If backend fails, try hardcoded credentials as fallback
        console.log('Backend authentication failed, trying hardcoded credentials...');
        console.log('Backend response:', res);
        
        var superAdminCredentials = {
            'admin@school.com': {
                password: 'admin123',
                fullName: 'Super Administrator'
            },
            'superadmin@school.com': {
                password: 'superadmin123',
                fullName: 'System Super Admin'
            }
        };
        
        // Check hardcoded credentials
        if (superAdminCredentials[email] && superAdminCredentials[email].password === password) {
            // Successful hardcoded login
            console.log('Hardcoded credentials authentication successful');
            currentAdmin = {
                email: email,
                role: 'super_admin',
                fullName: superAdminCredentials[email].fullName
            };
            
            localStorage.setItem('superAdmin', JSON.stringify(currentAdmin));
            msg.className = 'success';
            msg.textContent = 'Super Admin authentication successful! (Hardcoded)';
            
            setTimeout(function() {
                showApp();
            }, 1000);
        } else {
            console.log('Both backend and hardcoded authentication failed');
            msg.className = 'error';
            msg.textContent = 'Invalid Super Admin credentials. Make sure you have a super admin account with the correct email and password.';
        }
    });
}

// Initialize tab functionality
function initializeTabs() {
    console.log('Initializing Super Admin tabs...');
    
    // Make sure the first tab is active
    var firstTab = document.querySelector('.tab[data-tab="system-overview"]');
    var firstContent = document.getElementById('system-overview');
    
    if (firstTab && firstContent) {
        firstTab.classList.add('active');
        firstContent.classList.add('active');
    }
    
    // Add event listeners to all tabs
    var tabs = document.querySelectorAll('.tab[data-tab]');
    for (var i = 0; i < tabs.length; i++) {
        var tab = tabs[i];
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            var clickedTabName = this.dataset.tab;
            
            // Deactivate all tabs and content
            var allTabs = document.querySelectorAll('.tab');
            for (var j = 0; j < allTabs.length; j++) {
                allTabs[j].classList.remove('active');
            }
            var allContent = document.querySelectorAll('.tab-content');
            for (var k = 0; k < allContent.length; k++) {
                allContent[k].classList.remove('active');
            }
            
            // Activate clicked tab and its content
            this.classList.add('active');
            var targetContent = document.getElementById(clickedTabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    }
    
    // Logout button
    var logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('superAdmin');
            location.reload();
        });
    }
    
    // Form handlers
    var adminForm = document.getElementById('admin-form');
    if (adminForm) {
        adminForm.addEventListener('submit', handleAdminSubmit);
    }
    
    var termForm = document.getElementById('term-form');
    if (termForm) {
        termForm.addEventListener('submit', handleTermSubmit);
    }
    
    var settingsForm = document.getElementById('settings-form');
    if (settingsForm) {
        settingsForm.addEventListener('submit', handleSettingsSubmit);
    }
    
    var feeForm = document.getElementById('fee-form');
    if (feeForm) {
        feeForm.addEventListener('submit', handleFeeSubmit);
    }
}

// Update session time display
function updateSessionTime() {
    var sessionTimeElement = document.getElementById('session-time');
    if (sessionTimeElement) {
        var now = new Date();
        sessionTimeElement.textContent = now.toLocaleTimeString();
    }
}

// Load system statistics
function loadSystemStats() {
    console.log('Loading real system statistics from backend...');
    
    // Show loading state
    document.getElementById('total-students').textContent = 'Loading...';
    document.getElementById('total-admins').textContent = 'Loading...';
    document.getElementById('active-terms').textContent = 'Loading...';
    document.getElementById('total-revenue').textContent = 'Loading...';
    document.getElementById('monthly-revenue').textContent = 'Loading...';
    document.getElementById('outstanding-count').textContent = 'Loading...';
    document.getElementById('last-updated').textContent = 'Loading...';
    
    makeJsonpRequest({action: 'getSystemStats'}, function(res) {
        console.log('System stats response:', res);
        console.log('Response success:', res.success);
        console.log('Response stats:', res.stats);
        console.log('Response message:', res.message);
        
        if (res.success && res.stats) {
            var stats = res.stats;
            
            // Update the main statistics display
            document.getElementById('total-students').textContent = stats.totalStudents.toLocaleString();
            document.getElementById('total-admins').textContent = stats.totalAdmins.toLocaleString();
            document.getElementById('active-terms').textContent = stats.activeTerms.toLocaleString();
            document.getElementById('total-revenue').textContent = 'â‚¦' + stats.totalRevenue.toLocaleString();
            
            // Update additional statistics
            document.getElementById('monthly-revenue').textContent = 'â‚¦' + stats.monthlyRevenue.toLocaleString();
            document.getElementById('outstanding-count').textContent = stats.outstandingCount.toLocaleString();
            
            // Update last updated time and data source
            var lastUpdated = new Date(stats.lastUpdated);
            document.getElementById('last-updated').textContent = lastUpdated.toLocaleString();
            
            // Update backend status with data source info
            var dataSource = stats.dataSource || 'Google Sheets';
            document.getElementById('backend-status-text').textContent = 'Connected âœ… (' + dataSource + ')';
            document.getElementById('backend-status-text').style.color = '#28a745';
            
            // Store class counts for detailed view
            window.currentStats = stats;
            
            console.log('System statistics updated successfully');
        } else {
            console.error('Failed to load system statistics. Full response:', res);
            
            // Show error state
            document.getElementById('total-students').textContent = 'Error';
            document.getElementById('total-admins').textContent = 'Error';
            document.getElementById('active-terms').textContent = 'Error';
            document.getElementById('total-revenue').textContent = 'Error';
            document.getElementById('monthly-revenue').textContent = 'Error';
            document.getElementById('outstanding-count').textContent = 'Error';
            document.getElementById('last-updated').textContent = 'Error';
            
            // Update backend status
            document.getElementById('backend-status-text').textContent = 'Error âŒ';
            document.getElementById('backend-status-text').style.color = '#dc3545';
            
            // Show detailed error message
            var errorMsg = 'Failed to load system statistics.';
            if (res.message) {
                errorMsg += ' Error: ' + res.message;
            } else if (!res.success) {
                errorMsg += ' Backend returned success=false but no error message.';
            } else {
                errorMsg += ' Backend response missing stats data.';
            }
            
            console.error('Detailed error:', errorMsg);
            alert(errorMsg);
        }
    });
}

// Handle admin form submission
function handleAdminSubmit(e) {
    e.preventDefault();
    console.log('Super Admin - Admin form submitted');
    
    var password = document.getElementById('admin-password-input').value;
    
    // Validate password
    if (password.length < 6) {
        var msg = document.getElementById('admin-form-message');
        msg.className = 'error';
        msg.textContent = 'Password must be at least 6 characters long';
        return;
    }
    
    var formData = {
        action: 'addAdmin',
        email: document.getElementById('admin-email-input').value,
        password: password,
        role: document.getElementById('admin-role-input').value,
        fullName: document.getElementById('admin-fullname').value
    };
    
    makeJsonpRequest(formData, function(res) {
        var msg = document.getElementById('admin-form-message');
        if (res.success) {
            msg.className = 'success';
            msg.textContent = 'Administrator added successfully!';
            e.target.reset();
            loadAdminsList();
        } else {
            msg.className = 'error';
            msg.textContent = res.message || 'Error adding administrator';
        }
    });
}

// Handle term form submission
function handleTermSubmit(e) {
    e.preventDefault();
    console.log('Super Admin - Term form submitted');
    
    var formData = {
        action: 'addTerm',
        name: document.getElementById('term-name').value,
        academicYear: document.getElementById('academic-year').value,
        startDate: document.getElementById('term-start-date').value,
        endDate: document.getElementById('term-end-date').value,
        status: document.getElementById('term-status').value
    };
    
    makeJsonpRequest(formData, function(res) {
        var msg = document.getElementById('term-message');
        if (res.success) {
            msg.className = 'success';
            msg.textContent = 'Term added successfully!';
            e.target.reset();
            loadTermsTable();
        } else {
            msg.className = 'error';
            msg.textContent = res.message || 'Error adding term';
        }
    });
}

// Handle settings form submission
function handleSettingsSubmit(e) {
    e.preventDefault();
    console.log('Super Admin - Settings form submitted');
    
    var msg = document.getElementById('settings-message');
    msg.className = 'success';
    msg.textContent = 'System settings saved successfully!';
}

// Handle fee form submission
function handleFeeSubmit(e) {
    e.preventDefault();
    console.log('Super Admin - Fee form submitted');
    
    var formData = {
        action: 'addFee',
        feeName: document.getElementById('fee-name').value,
        feeAmount: parseFloat(document.getElementById('fee-amount').value),
        termId: document.getElementById('fee-term').value,
        class: document.getElementById('fee-class').value,
        category: document.getElementById('fee-category').value
    };
    
    makeJsonpRequest(formData, function(res) {
        var msg = document.getElementById('fee-form-message');
        if (res.success) {
            msg.className = 'success';
            msg.textContent = 'Fee added successfully!';
            e.target.reset();
            loadFeesList();
        } else {
            msg.className = 'error';
            msg.textContent = res.message || 'Error adding fee';
        }
    });
}

// Load fees list
function loadFeesList() {
    makeJsonpRequest({action: 'getFees'}, function(res) {
        var tbody = document.getElementById('fees-table-body');
        tbody.innerHTML = '';
        
        if (res.success && res.fees && res.fees.length > 0) {
            for (var i = 0; i < res.fees.length; i++) {
                var fee = res.fees[i];
                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + fee.feeName + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">â‚¦' + fee.feeAmount.toLocaleString() + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + (fee.termName || fee.termId) + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + fee.class + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + fee.category.toUpperCase() + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + (fee.status || 'active') + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' +
                        '<button onclick="editFee(\'' + fee.id + '\')" style="background: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Edit</button>' +
                        '<button onclick="deleteFee(\'' + fee.id + '\')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Delete</button>' +
                    '</td>';
                tbody.appendChild(row);
            }
        } else {
            var row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" style="padding: 20px; text-align: center; color: #6c757d;">No fees found</td>';
            tbody.appendChild(row);
        }
    });
}

// Load terms for fee form dropdown
function loadTermsForFees() {
    makeJsonpRequest({action: 'getTerms'}, function(res) {
        var termSelect = document.getElementById('fee-term');
        if (termSelect) {
            termSelect.innerHTML = '<option value="">-- Select Term --</option>';
            
            if (res.success && res.terms && res.terms.length > 0) {
                for (var i = 0; i < res.terms.length; i++) {
                    var term = res.terms[i];
                    var option = document.createElement('option');
                    option.value = term.id;
                    option.textContent = term.name + ' (' + term.academicYear + ')';
                    termSelect.appendChild(option);
                }
            }
        }
    });
}

// Edit fee function
function editFee(feeId) {
    // Get current fee data first
    makeJsonpRequest({action: 'getFee', feeId: feeId}, function(res) {
        if (res.success && res.fee) {
            var fee = res.fee;
            var newName = prompt('Enter new fee name:', fee.feeName);
            if (newName && newName !== fee.feeName) {
                var newAmount = prompt('Enter new fee amount (â‚¦):', fee.feeAmount);
                if (newAmount && !isNaN(parseFloat(newAmount))) {
                    makeJsonpRequest({
                        action: 'updateFee',
                        feeId: feeId,
                        feeName: newName,
                        feeAmount: parseFloat(newAmount)
                    }, function(updateRes) {
                        if (updateRes.success) {
                            alert('Fee updated successfully!');
                            loadFeesList();
                        } else {
                            alert('Error updating fee: ' + (updateRes.message || 'Unknown error'));
                        }
                    });
                }
            } else if (newName) {
                // Only name changed
                makeJsonpRequest({
                    action: 'updateFee',
                    feeId: feeId,
                    feeName: newName
                }, function(updateRes) {
                    if (updateRes.success) {
                        alert('Fee name updated successfully!');
                        loadFeesList();
                    } else {
                        alert('Error updating fee: ' + (updateRes.message || 'Unknown error'));
                    }
                });
            }
        } else {
            alert('Error loading fee details: ' + (res.message || 'Unknown error'));
        }
    });
}

// Delete fee function
function deleteFee(feeId) {
    if (confirm('Are you sure you want to delete this fee? This action cannot be undone.')) {
        makeJsonpRequest({action: 'deleteFee', feeId: feeId}, function(res) {
            if (res.success) {
                alert('Fee deleted successfully!');
                loadFeesList();
            } else {
                alert('Error deleting fee: ' + (res.message || 'Unknown error'));
            }
        });
    }
}

// Export fees data
function exportFeesData() {
    alert('Fee data export initiated. Download will start shortly.');
}

// Load admins list
function loadAdminsList() {
    makeJsonpRequest({action: 'getAdmins'}, function(res) {
        var tbody = document.getElementById('admins-table-body');
        tbody.innerHTML = '';
        
        if (res.success && res.admins && res.admins.length > 0) {
            for (var i = 0; i < res.admins.length; i++) {
                var admin = res.admins[i];
                var roleIcon = getRoleIcon(admin.role);
                var passwordDisplay = admin.password ? 
                    '<span style="font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 12px;">' + admin.password + '</span>' : 
                    '<span style="color: #6c757d; font-style: italic;">Not available</span>';
                
                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + admin.email + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + (admin.fullName || '') + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + roleIcon + ' ' + admin.role.replace('_', ' ').toUpperCase() + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + passwordDisplay + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + (admin.status || 'active') + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' +
                        '<button onclick="editAdmin(\'' + admin.email + '\')" style="background: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Edit</button>' +
                        '<button onclick="editAdminPassword(\'' + admin.email + '\')" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Change Password</button>' +
                        '<button onclick="deleteAdmin(\'' + admin.email + '\')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Delete</button>' +
                    '</td>';
                tbody.appendChild(row);
            }
        } else {
            var row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">No administrators found</td>';
            tbody.appendChild(row);
        }
    });
}

// Load terms table
function loadTermsTable() {
    makeJsonpRequest({action: 'getTerms'}, function(res) {
        var tbody = document.getElementById('terms-table-body');
        tbody.innerHTML = '';
        
        if (res.success && res.terms && res.terms.length > 0) {
            for (var i = 0; i < res.terms.length; i++) {
                var term = res.terms[i];
                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + term.name + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + term.academicYear + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + term.startDate + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + term.endDate + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' + term.status + '</td>' +
                    '<td style="padding: 12px; border: 1px solid #dee2e6;">' +
                        '<button onclick="editTerm(\'' + term.id + '\')" style="background: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Edit</button>' +
                        '<button onclick="deleteTerm(\'' + term.id + '\')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 2px;">Delete</button>' +
                    '</td>';
                tbody.appendChild(row);
            }
        } else {
            var row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">No terms found</td>';
            tbody.appendChild(row);
        }
    });
}

// Get role icon
function getRoleIcon(role) {
    var icons = {
        'super_admin': 'ğŸ”',
        'finance_admin': 'ğŸ’°',
        'registrar': 'ğŸ“',
        'accountant': 'ğŸ’³'
    };
    return icons[role] || 'ğŸ‘¤';
}

function loadFallbackStats() {
    console.log('Loading fallback test statistics...');
    
    // Show loading state
    document.getElementById('total-students').textContent = 'Loading...';
    document.getElementById('total-admins').textContent = 'Loading...';
    document.getElementById('active-terms').textContent = 'Loading...';
    document.getElementById('total-revenue').textContent = 'Loading...';
    document.getElementById('monthly-revenue').textContent = 'Loading...';
    document.getElementById('outstanding-count').textContent = 'Loading...';
    document.getElementById('last-updated').textContent = 'Loading...';
    
    makeJsonpRequest({action: 'getSystemStatsBasic'}, function(res) {
        console.log('Fallback stats response:', res);
        
        if (res.success && res.stats) {
            var stats = res.stats;
            
            // Update the main statistics display
            document.getElementById('total-students').textContent = stats.totalStudents.toLocaleString();
            document.getElementById('total-admins').textContent = stats.totalAdmins.toLocaleString();
            document.getElementById('active-terms').textContent = stats.activeTerms.toLocaleString();
            document.getElementById('total-revenue').textContent = 'â‚¦' + stats.totalRevenue.toLocaleString();
            
            // Update additional statistics
            document.getElementById('monthly-revenue').textContent = 'â‚¦' + stats.monthlyRevenue.toLocaleString();
            document.getElementById('outstanding-count').textContent = stats.outstandingCount.toLocaleString();
            
            // Update last updated time and data source
            var lastUpdated = new Date(stats.lastUpdated);
            document.getElementById('last-updated').textContent = lastUpdated.toLocaleString();
            
            // Update backend status with data source info
            var dataSource = stats.dataSource || 'Test Data';
            document.getElementById('backend-status-text').textContent = 'Connected âœ… (' + dataSource + ')';
            document.getElementById('backend-status-text').style.color = '#fd7e14'; // Orange for test data
            
            // Store class counts for detailed view
            window.currentStats = stats;
            
            console.log('Fallback statistics loaded successfully');
            alert('âœ… Test data loaded successfully!\n\nThis is sample data to verify the interface works.\nTo see real data, fix your spreadsheet connection and click "ğŸ”„ Refresh Stats".');
        } else {
            console.error('Failed to load fallback statistics:', res);
            alert('âŒ Even test data failed to load!\n\nThis indicates a serious backend issue.\nPlease check your Google Apps Script deployment.');
        }
    });
}

function refreshSystemStats() {
    loadSystemStats();
}

function testBackendConnection() {
    console.log('Testing backend connection...');
    
    // Test basic connection
    makeJsonpRequest({action: 'test'}, function(res) {
        console.log('Backend test response:', res);
        
        if (res.success) {
            console.log('âœ… Basic backend connection successful');
            
            // Now test getSystemStats specifically
            console.log('Testing getSystemStats endpoint...');
            makeJsonpRequest({action: 'getSystemStats'}, function(statsRes) {
                console.log('getSystemStats test response:', statsRes);
                console.log('Full getSystemStats response object:', JSON.stringify(statsRes, null, 2));
                
                if (statsRes.success) {
                    var statsInfo = '';
                    if (statsRes.stats) {
                        statsInfo += '\nğŸ“Š Statistics Summary:\n';
                        statsInfo += 'â€¢ Students: ' + (statsRes.stats.totalStudents || 0) + '\n';
                        statsInfo += 'â€¢ Admins: ' + (statsRes.stats.totalAdmins || 0) + '\n';
                        statsInfo += 'â€¢ Active Terms: ' + (statsRes.stats.activeTerms || 0) + '\n';
                        statsInfo += 'â€¢ Total Revenue: â‚¦' + (statsRes.stats.totalRevenue || 0).toLocaleString() + '\n';
                        statsInfo += 'â€¢ Monthly Revenue: â‚¦' + (statsRes.stats.monthlyRevenue || 0).toLocaleString() + '\n';
                        statsInfo += 'â€¢ Outstanding: ' + (statsRes.stats.outstandingCount || 0) + '\n';
                        statsInfo += 'â€¢ Data Source: ' + (statsRes.stats.dataSource || 'Unknown') + '\n';
                        
                        if (statsRes.stats.spreadsheetId) {
                            statsInfo += 'â€¢ Spreadsheet ID: ' + statsRes.stats.spreadsheetId + '\n';
                        }
                        
                        if (statsRes.stats.errors && statsRes.stats.errors.length > 0) {
                            statsInfo += '\nâš ï¸ Warnings:\n';
                            for (var i = 0; i < statsRes.stats.errors.length; i++) {
                                statsInfo += 'â€¢ ' + statsRes.stats.errors[i] + '\n';
                            }
                        }
                        
                        if (statsRes.stats.classCounts && Object.keys(statsRes.stats.classCounts).length > 0) {
                            statsInfo += '\nğŸ“š Class Breakdown:\n';
                            for (var className in statsRes.stats.classCounts) {
                                statsInfo += 'â€¢ ' + className + ': ' + statsRes.stats.classCounts[className] + ' students\n';
                            }
                        }
                    }
                    
                    alert('âœ… getSystemStats endpoint working!\n\nReal data loaded successfully!' + statsInfo);
                } else {
                    var errorDetails = 'âŒ getSystemStats endpoint failed!\n\n';
                    errorDetails += 'Success: ' + statsRes.success + '\n';
                    errorDetails += 'Message: ' + (statsRes.message || 'No message') + '\n';
                    errorDetails += 'Error: ' + (statsRes.error || 'No error details') + '\n';
                    
                    if (statsRes.spreadsheetId) {
                        errorDetails += 'Spreadsheet ID: ' + statsRes.spreadsheetId + '\n';
                    }
                    
                    if (statsRes.suggestion) {
                        errorDetails += 'Suggestion: ' + statsRes.suggestion + '\n';
                    }
                    
                    if (statsRes.availableActions) {
                        errorDetails += 'Available actions: ' + statsRes.availableActions.join(', ') + '\n';
                    }
                    
                    errorDetails += '\nğŸ”„ Trying fallback test data...\n';
                    
                    // Try fallback basic stats
                    makeJsonpRequest({action: 'getSystemStatsBasic'}, function(basicRes) {
                        console.log('Basic stats fallback response:', basicRes);
                        
                        if (basicRes.success) {
                            errorDetails += 'âœ… Fallback test data works!\n';
                            errorDetails += 'This means the backend is working but there may be an issue with your spreadsheet.\n\n';
                            errorDetails += 'ğŸ“‹ Next Steps:\n';
                            errorDetails += '1. Check if your Google Sheet exists and is accessible\n';
                            errorDetails += '2. Verify the SPREADSHEET_ID in your Google Apps Script\n';
                            errorDetails += '3. Make sure all required sheets exist (Students, Admins, Terms, Payments, Fees)\n';
                            errorDetails += '4. Check Google Apps Script execution logs\n';
                            errorDetails += '5. See debug-system-stats.md for detailed instructions';
                        } else {
                            errorDetails += 'âŒ Even fallback test data failed!\n';
                            errorDetails += 'This indicates a serious backend deployment issue.\n\n';
                            errorDetails += 'ğŸ“‹ Next Steps:\n';
                            errorDetails += '1. Redeploy your Google Apps Script\n';
                            errorDetails += '2. Check Apps Script execution logs\n';
                            errorDetails += '3. Verify script permissions\n';
                            errorDetails += '4. See debug-system-stats.md for details';
                        }
                        
                        alert(errorDetails);
                    });
                }
            });
        } else {
            alert('âŒ Backend connection failed!\n\nError: ' + (res.message || 'Unknown error'));
        }
    });
}

function exportSystemData() {
    alert('System data export initiated. You will receive a download link shortly.');
}

function viewSystemLogs() {
    document.querySelector('.tab[data-tab="audit-logs"]').click();
}

function openRegularAdmin() {
    window.open('index-working.html', '_blank');
}

function viewDetailedStats() {
    var detailedStats = document.getElementById('detailed-stats');
    var classStats = document.getElementById('class-stats');
    
    if (detailedStats.style.display === 'none') {
        detailedStats.style.display = 'block';
        
        // Show class breakdown if available
        if (window.currentStats && window.currentStats.classCounts) {
            var classCountsHtml = '';
            var classCounts = window.currentStats.classCounts;
            
            for (var className in classCounts) {
                if (classCounts.hasOwnProperty(className)) {
                    classCountsHtml += '<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">';
                    classCountsHtml += '<span>' + className + ':</span>';
                    classCountsHtml += '<strong>' + classCounts[className] + ' students</strong>';
                    classCountsHtml += '</div>';
                }
            }
            
            if (classCountsHtml) {
                classStats.innerHTML = classCountsHtml;
            } else {
                classStats.innerHTML = 'No class data available';
            }
        } else {
            classStats.innerHTML = 'Class breakdown not available. Please refresh statistics.';
        }
    } else {
        detailedStats.style.display = 'none';
    }
}

function editAdmin(email) {
    var newName = prompt('Enter new full name for ' + email + ':');
    if (newName) {
        makeJsonpRequest({
            action: 'updateAdmin',
            email: email,
            fullName: newName
        }, function(res) {
            if (res.success) {
                alert('Administrator updated successfully!');
                loadAdminsList();
            } else {
                alert('Error updating administrator: ' + (res.message || 'Unknown error'));
            }
        });
    }
}

function editAdminPassword(email) {
    var newPassword = prompt('Enter new password for ' + email + ':\n\nPassword must be at least 6 characters long.');
    if (newPassword) {
        // Validate password length
        if (newPassword.length < 6) {
            alert('Password must be at least 6 characters long. Please try again.');
            return;
        }
        
        // Confirm password change
        if (confirm('Are you sure you want to change the password for ' + email + '?\n\nNew password: ' + newPassword)) {
            makeJsonpRequest({
                action: 'updateAdminPassword',
                email: email,
                password: newPassword
            }, function(res) {
                if (res.success) {
                    alert('Password updated successfully for ' + email + '!');
                    loadAdminsList();
                } else {
                    alert('Error updating password: ' + (res.message || 'Unknown error'));
                }
            });
        }
    }
}

function deleteAdmin(email) {
    if (confirm('Are you sure you want to delete administrator: ' + email + '?')) {
        makeJsonpRequest({action: 'deleteAdmin', email: email}, function(res) {
            if (res.success) {
                alert('Administrator deleted successfully!');
                loadAdminsList();
            } else {
                alert('Error deleting administrator: ' + (res.message || 'Unknown error'));
            }
        });
    }
}

function editTerm(termId) {
    var newName = prompt('Enter new term name:');
    if (newName) {
        makeJsonpRequest({
            action: 'updateTerm',
            termId: termId,
            name: newName
        }, function(res) {
            if (res.success) {
                alert('Term updated successfully!');
                loadTermsTable();
            } else {
                alert('Error updating term: ' + (res.message || 'Unknown error'));
            }
        });
    }
}

function deleteTerm(termId) {
    if (confirm('Are you sure you want to delete this term?')) {
        makeJsonpRequest({action: 'deleteTerm', termId: termId}, function(res) {
            if (res.success) {
                alert('Term deleted successfully!');
                loadTermsTable();
            } else {
                alert('Error deleting term: ' + (res.message || 'Unknown error'));
            }
        });
    }
}

function loadAuditLogs() {
    var tbody = document.getElementById('audit-logs-body');
    tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6c757d;">Loading audit logs...</td></tr>';
    
    // Simulate loading logs
    setTimeout(function() {
        tbody.innerHTML = 
            '<tr>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">2024-01-15 14:30:25</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">admin@school.com</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">Admin Created</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">Created new Finance Admin account</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">192.168.1.100</td>' +
            '</tr>' +
            '<tr>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">2024-01-15 13:15:10</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">admin@school.com</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">Term Added</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">Added First Term 2024</td>' +
                '<td style="padding: 12px; border: 1px solid #dee2e6;">192.168.1.100</td>' +
            '</tr>';
    }, 1000);
}

function exportAuditLogs() {
    alert('Audit logs export initiated. Download will start shortly.');
}

function clearOldLogs() {
    if (confirm('Are you sure you want to clear logs older than 90 days?')) {
        alert('Old audit logs cleared successfully.');
    }
}

function createBackup() {
    var backupName = document.getElementById('backup-name').value;
    if (!backupName) {
        alert('Please enter a backup name.');
        return;
    }
    
    var msg = document.getElementById('backup-message');
    msg.className = 'info';
    msg.textContent = 'Creating backup...';
    
    setTimeout(function() {
        msg.className = 'success';
        msg.textContent = 'Backup created successfully: ' + backupName + '.json';
    }, 2000);
}

function restoreBackup() {
    var fileInput = document.getElementById('restore-file');
    if (!fileInput.files.length) {
        alert('Please select a backup file.');
        return;
    }
    
    if (confirm('Are you sure you want to restore from backup? This will overwrite current data.')) {
        var msg = document.getElementById('restore-message');
        msg.className = 'info';
        msg.textContent = 'Restoring from backup...';
        
        setTimeout(function() {
            msg.className = 'success';
            msg.textContent = 'System restored successfully from backup.';
        }, 3000);
    }
}

// JSONP Helper
function makeJsonpRequest(params, callback) {
    var cbName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    var timeoutId;
    
    window[cbName] = function(data) { 
        clearTimeout(timeoutId);
        callback(data); 
        delete window[cbName];
        
        var script = document.querySelector('script[src*="' + cbName + '"]');
        if (script && document.head.contains(script)) {
            document.head.removeChild(script);
        }
    };
    
    var url = new URL(scriptURL);
    for (var key in params) {
        if (params.hasOwnProperty(key)) {
            url.searchParams.append(key, params[key]);
        }
    }
    url.searchParams.append('callback', cbName);
    
    var script = document.createElement('script'); 
    script.src = url;
    script.onerror = function() {
        clearTimeout(timeoutId);
        callback({
            success: false, 
            message: 'Backend connection failed.'
        });
        delete window[cbName];
        if (document.head.contains(script)) {
            document.head.removeChild(script);
        }
    };
    
    document.head.appendChild(script);
    
    timeoutId = setTimeout(function() {
        callback({
            success: false, 
            message: 'Request timeout.'
        });
        delete window[cbName];
        if (document.head.contains(script)) {
            document.head.removeChild(script);
        }
    }, 15000);
}

console.log('Super Admin Portal JavaScript loaded successfully');
</script>

<div style="text-align: center; padding: 20px 0 0; font-style: italic; color: #888;">
    ğŸ” Super Admin Portal - Powered by BerachahGlobalConcept
</div>

</body>
</html>